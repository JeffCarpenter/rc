#!/bin/zsh -v

# emacsclient -n -f ~/.emacs.d/server/general "$@"

local prog=$(basename $0)
local alternative_editor
alternate_editors=( em zile mg jove sensible-editor vim joe )

local server_file="${HOME}/.emacs.d/server/general"
local lhost=$(hostname -s)

print remoteedit: ${remoteedit}
print DISPLAY: ${DISPLAY}
print prog: ${prog}

# local rhost=s@ubuntu-sharad
# local rproto=scpc
# local rserver_file="${HOME}/.emacs.d/server/general"
# local lhost=$(hostname -s)

debug=1

typeset -A args

if (( ${+remoteedit})) ; then
    args[-f]=${remoteditsocfile}
else
    args[-f]=${server_file}
fi

args[-f]=".emacs.d/server/general"

# if [[ $prog =~ .*n$ ]]  ; then
#     args[-n]=""
# fi

if [ $prog = "xedn" -o $prog = "edn"  ]  ; then
    args[-n]=""
fi


if [ $# -eq 0 ] ; then
    args[-c]=""
fi

    foreach editor ( $alternate_editors )
    do
    if which $editor >& /dev/null ; then
        alted=$editor
        break
    fi
    done


case "$prog" in
    (general-xeditor*|xeditor*|xed*)
        # args[-d]="$DISPLAY";;
        : ;;
    # (general-editor*|editor*|ed*)
    #     args[-t]="";;
    (*)  ;;
esac


foreach f ("$@" ) {
    [ -f $f ] && filegiven=
}

# if (( ${+remoteedit} )) ; then
#     # (( ${+debug} )) && echo eval ssh ${rhost} emacsclient ${(kv)args} ${filegiven--c} ${alted:+ -a $alted} /${rproto}:${lhost}:$(readlink -m "$@")
#     # eval ssh ${rhost} emacsclient ${(kv)args} ${filegiven--c} ${alted:+ -a $alted} /${rproto}:${lhost}:$(readlink -m "$@")
#     (( ${+debug} )) && echo ssh ${remoteedit} $prog /${remoteeditproto}:${lhost}:$(readlink -m "$@")
#     print ssh -X ${remoteedit} $prog /${remoteeditproto}:${lhost}:$(readlink -m "$@")
# else
#     if which emacs >& /dev/null && which emacsclient >& /dev/null ; then
#         (( ${+debug} )) && echo eval emacsclient ${(kv)args} ${filegiven--c} ${alted:+ -a $alted} "$@"
#         print eval emacsclient ${(kv)args} ${filegiven--c} ${alted:+ -a $alted} "$@"
#     else
#         $alted "$@"
#     fi
# fi


    # (( ${+debug} )) && echo eval ssh ${rhost} emacsclient ${(kv)args} ${filegiven--c} ${alted:+ -a $alted} /${rproto}:${lhost}:$(readlink -m "$@")
    # eval ssh ${rhost} emacsclient ${(kv)args} ${filegiven--c} ${alted:+ -a $alted} /${rproto}:${lhost}:$(readlink -m "$@")
if (( ${+remoteedit} )) ; then
    (( ${+debug} )) && print eval ssh ${rhost} emacsclient ${(kv)args} ${filegiven--c} ${alted:+ -a $alted} /${remoteeditproto}:${lhost}:$(readlink -m "$@")
    eval ssh ${remoteedit} emacsclient ${(kv)args} ${filegiven--c} ${alted:+ -a $alted} /${remoteeditproto}:${lhost}:$(readlink -m "$@")
else
    if which emacs >& /dev/null && which emacsclient >& /dev/null ; then
        (( ${+debug} )) && echo eval emacsclient ${(kv)args} ${filegiven--c} ${alted:+ -a $alted} "$@"
        eval emacsclient ${(kv)args} ${filegiven--c} ${alted:+ -a $alted} "$@"
    else
        $alted "$@"
    fi
fi
